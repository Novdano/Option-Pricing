---
title: "Compare Models Delta"
output: html_document
---



```{r}
library("NMOF")
```


Black Scholes
```{r}
BS_V0 <- function(S_0, K, r, sigma, T){
  d1 <- (log(S_0/K) + (r + sigma^2/2)*T)/(sigma * sqrt(T)) 
  d2 <- (log(S_0/K) + (r - sigma^2/2)*T)/(sigma * sqrt(T)) 
  res <- S_0 * pnorm(d1) - K*pnorm(d2) * exp(-r * T)
  return(res)
}

deltaBS <- function(S_0, K, r, sigma, T){
  d1 <- (log(S_0/K) + (r + sigma^2/2)*T)/(sigma * sqrt(T)) 
  res <- pnorm(d1) 
  return(res)
}

```

Heston
```{r}
hestonDeltaApprox <- function(S, K, tau, r, vol, theta, rho, kappa, miu, delta){
  return((callHestoncf(S+delta, K, tau, r, 0 ,vol, theta, rho, kappa, miu)-callHestoncf(S-delta, K, tau, r, 0 ,vol, theta, rho, kappa, miu))/(2*delta))
}
```

SABR
```{r}
IV_SABR <- function(f, K, t, alpha, beta, rho, nu){
  first = alpha/((f*K)^((1-beta)/2) *(1 + ((1-beta)^4)/24 *log(f/K)^2 + ((1-beta^4)/1920)*log(f/K)^4))
  z = nu/alpha * ((f*K)^(1-beta)/2) * log(f/K)
  chi_z = log((sqrt(1-2*rho*z+z^2) + z - rho)/(1-rho))
  last = 1 + (((1-beta)^2/24) * alpha^2/(f*K)^(1-beta) + 1/4 * ((rho*beta*nu*alpa)/((f*K)^((1-beta)/2))) + ((2-3*rho^2)/24)*nu^2)
  return (first * (x/chi_z) * last * t)
}

```

Parse Data
```{r}
itm <- read.csv("MSFT_Data/MSFT_HIST_95Call_081718.csv")
atm <- read.csv("MSFT_Data/MSFT_HIST_100Call_081718.csv")
otm <- read.csv("MSFT_Data/MSFT_HIST_105Call_081718.csv")
stock <- read.csv("MSFT_Data/MSFT_Equity.csv")


stock_px <- na.omit(stock[,2])
itm_px <- na.omit(itm[,2])
atm_px <- na.omit(atm[,2])
otm_px <- na.omit(otm[,2])

delta_itm <- na.omit(itm[,3])
delta_atm <- na.omit(atm[,3])
delta_otm <- na.omit(otm[,3])

N <- length(stock_px)
delta_BS_itm <- rep(0,N)
delta_BS_atm <- rep(0,N)
delta_BS_otm <- rep(0,N)
for (i in 1:N){
  r <- 0
  if (as.Date(stock[i,1], "%m/%d/%Y") > (as.Date("06/14/2018","%m/%d/%Y"))){
    r <- 0.02
  } else {
    r <- 0.0175
  }
  
  delta_BS_itm[[i]] <- deltaBS(stock_px[[i]], 95, r, 0.2, T)
  delta_BS_atm[[i]] <- deltaBS(stock_px[[i]], 100, r, 0.2, T)
  delta_BS_otm[[i]] <- deltaBS(stock_px[[i]], 105, r, 0.2, T)
}
```

Get Historcal Volatility
```{r}
hist_stock <- read.csv("MSFT_Data/MSFT_HIST_05to06.csv")
hist_px <- hist_stock[,2]
na.omit(hist_px)
n <- length(hist_px)

#takes in array of price and returns an array of day to day return
hist_returns <- function(px){
  N <- length(px)
  ret <- rep(0,N-1)
  for (i in 2:N){
    ret[[i-1]] <- log(px[[i]]/px[[i-1]])
  }
  return (ret)
}
```

Compare strategy PnL
```{r}
#Long one call, hedge with stock
BS_IV <- sd(hist_returns(hist_px)) * sqrt(252)
delta_bs <- deltaBS(stock_px[[1]], 100, 0.0175, BS_IV, 55/252)
delta_mkt <- delta_BS_atm[[1]]
#current value of portfolio
port_bs <- atm_px[[1]] - delta_bs * stock_px[[1]]
port_mkt <- atm_px[[1]] - delta_mkt * stock_px[[1]]
#daily profit and loss
daily_pnl_bs <- rep(0,length(stock_px))
daily_pnl_mkt <- rep(0,length(stock_px))
daily_pnl_bs[[1]] <- -port_bs
daily_pnl_mkt[[1]] <- -port_mkt
deltas_bs <- rep(0,length(stock_px))
deltas_bs[[1]] <- delta_bs
stock_held_BS <- rep(0,length(stock_px))
stock_held_mkt <- rep(0, length(stock_px))
stock_held_BS[[1]] <- -delta_bs
stock_held_mkt[[1]] <- -delta_mkt
days_left <- 55
for (i in 2:length(stock_px)){
  days_skipped <- as.numeric(as.Date(stock[i,1], "%m/%d/%Y") - as.Date(stock[i-1,1], "%m/%d/%Y"))
  days_left <- days_left - days_skipped
  if (as.Date(stock[i,1], "%m/%d/%Y") > (as.Date("06/14/2018","%m/%d/%Y"))){
    r <- 0.02
  } else {
    r <- 0.0175
  }
  new_vol <- c(hist_px[i:length(hist_px)], head(stock_px,i-1))
  new_deltaBS <- deltaBS(stock_px[[i]], 100, r, BS_IV, days_left/252)
  new_deltaMkt <- delta_atm[[i]]
  delta_bs <- new_deltaBS + stock_held_BS[[i-1]]
  delta_mkt <- new_deltaMkt + stock_held_mkt[[i-1]]
  port_bs <- port_bs - delta_bs * stock_px[[i]]
  port_mkt <- port_mkt - delta_mkt * stock_px[[i]]
  daily_pnl_bs[[i]] <- -port_bs
  daily_pnl_mkt[[i]] <- -port_mkt
  deltas_bs[[i]] <- new_deltaBS
  stock_held_BS[[i]] <- -delta_bs + stock_held_BS[[i-1]]
  stock_held_mkt[[i]] <- -delta_mkt + stock_held_mkt[[i-1]]
}

plot(1:length(stock_px),daily_pnl_mkt,col="red", "l", ylab="PnL", xlab="Time")
lines(1:length(stock_px), daily_pnl_bs, col="green", "l")
legend("topright",
       c("Market","BlackScholes"),
       fill=c("red","green"))

plot(1:length(stock_px), delta_atm, col="red", "l",ylab="Delta", xlab="Time")
lines(1:length(stock_px), deltas_bs, col="green", "l")
legend("topright",
       c("Market","BlackScholes"),
       fill=c("red","green"))

plot(1:length(stock_px), stock_held_mkt, col="red", "l",ylab="Stock Held", xlab="Time")
lines(1:length(stock_px), stock_held_BS, col="green", "l")
legend("topleft",
       c("Market","BlackScholes"),
       fill=c("red","green"))


```

